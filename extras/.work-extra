#!/usr/bin/env bash
#

export RGRAV_HOME="/c/Users/douglasm/solutions/rgrav"
#export PATH=$JAVA_HOME/bin:$PATH:$RGRAV_HOME
#source $RGRAV_HOME/rgrav-completion.bash
export PATH=$PATH:/c/Users/douglasm/stash/scripts:/c/Users/douglasm/stash/solution_helpers/graviton:/c/Users/douglasm/stash/solution_helpers/network:$RGRAV_HOME

# GIT Configurations
GIT_AUTHOR_NAME="Douglas Morand"
GIT_COMMITTER_NAME="$GIT_AUTHOR_NAME"
git config --global user.name "$GIT_AUTHOR_NAME"
GIT_AUTHOR_EMAIL="douglas.morand@orionhealth.com"
GIT_COMMITTER_EMAIL="$GIT_AUTHOR_EMAIL"
git config --global user.email "$GIT_AUTHOR_EMAIL"

if [ -f ~/.ssh-agent ]; then . ~/.ssh-agent; fi

sudo cp ~/dotfiles/extras/windows/resolv.conf /etc/resolv.conf

exe() { echo "\$ $@" ; "$@" ; }

function ssh_proxy(){
    echo "Starting ssh proxy in background on port: 12345"
    ssh -D 12345 -N douglasm@graviton-jump-host-scottsdale 2>&1 & 

    pid=$!
    echo "Kill process $pid once finished..."
}

function graviton_tunnel(){
    # Builds tunnels via the graviton jumphost
    #
    # Arg 1 - hostname to tunnel e.g. hbc-review-graviton-jump-host-scottsdale.graviton.odl.io
    # Arg 2..n - Files to setup tunnels

    tunnels=()
    graviton_env=$1
    echo "Building Tunnels"
    echo "======================================"
    for tunnelFile in ${@:2}; do
        while IFS= read line
        do
            if [[ ! -z "$line" && "$line" != "#"* ]]; then
                host=${line/<HOST>/$graviton_env}
                echo $host
                tunnels+=("-L $host")
            fi
        done < "$tunnelFile"
    done
    echo ""
	exe ssh graviton-jump-host "${tunnels[@]}"
}

function bastion_tunnel(){
    # Builds tunnels via the Bastion jumphost
    # Pass 1..n files to setup tunnels

    tunnels=()
    for tunnelFile in $@; do
        while IFS= read line
        do
            if [[ ! -z "$line" && "$line" != "#"* ]]; then
                #echo "$line"
                tunnels+=("-L $line")
            fi
        done < "$tunnelFile"
    done
	exe ssh bastion "${tunnels[@]}"
}

function ssh_aws(){
    ssh -i ~/.ssh/puppet_id_rsa centos@$1
}

function pushJumphost(){
    if [[ $# -ne 1 ]]; then
        echo "Must declare target directory.  E.g. solutions/hbc_review"
        return 1
    fi

    rsync -rvzh --progress .gitignore graviton-jump-host:~/$1/.gitignore	
    rsync -rvzh --progress --stats --filter=':- .gitignore' . graviton-jump-host:~/$1
}

function pullJumphost(){
    if [[ $# -ne 1 ]]; then
        echo "Must declare target directory.  E.g. solutions/hbc_review"
        return 1
    fi

    rsync -azv --progress graviton-jump-host:~/$1/.gitignore .
    rsync -avzh --delete --progress --stats --filter=':- .gitignore' graviton-jump-host:~/$1/ .
    #rsync -rzvh --size-only --delete --progress --stats --filter=':- .gitignore' graviton-jump-host:~/$1/ .
}

function downloadGravitonLogs(){
    jumphost="graviton-jump-host"
    solution=""
    
    while getopts ":j:s:" opt; do
        case $opt in
            j)
                jumphost=$OPTARG
                echo "-j was triggered, param: $jumphost" >&2
                ;;
            s)
                solution=$OPTARG
                echo "-s was triggered, param: $solution" >&2
                ;;
            \?)
                echo "Invalid option: -$OPTARG" >&2
                return 1
                ;;
            :)
                echo "Option $OPTARG requires an argument" >&2
                return 1
                ;;
        esac
    done 

    if [[ -z "$solution" ]]; then
        echo "Must declare a solution directory. e.g. solutions/hbc_review"
        return 1
    fi

    # compress up the log files
    echo "Retrieving logs from $jumphost [$solution], and packaging up for copy..."
    #&> /dev/null
    
    ssh $jumphost -- "cd ~/$solution; graviton retrieve-logs -p ec2; tar -vczf graviton_logs.tar.gz graviton.log agent-logs/" &> /dev/null
    # scp the file
    echo "Copying graviton logs"
    scp $jumphost:~/$solution/graviton_logs.tar.gz .
    
    echo "Cleaning up..."
    ssh $jumphost -- "cd ~/$solution; rm graviton_logs.tar.gz" &>/dev/null
}

# NOT USED
run_ticker() {
  pid=$1 # Process Id of the previous running command
  text=$2
  spin='-\|/'
  i=0
  while kill -0 $pid 2>/dev/null
  do
    i=$(( (i+1) %4 ))
    printf "\r$text ${spin:$i:1}"
    sleep .1
  done
}